```{r}
#| label: trendfunc
#| cache: true
#| cache.comments: false

trendfunc <- function(data = rsdata, event, time, eventname, strata = NULL, addstrataname = NULL, ybreaks = NULL, yearstart = 2003, yearvar = "indexyear_fac") {
  r <- data %>%
    filter(shf_indexyear >= yearstart) %>%
    mutate(!!sym(yearvar) := droplevels(!!sym(yearvar))) %>%
    group_by(!!sym(strata), !!sym(yearvar)) %>%
    summarise(
      ev = sum(!!sym(event) == "Yes"),
      s = sum(!!sym(time) / 365.25),
      .groups = "drop"
    ) %>%
    rename(level = !!sym(strata)) %>%
    mutate(
      rate = ev / s * 100,
      level = paste0(addstrataname, level),
      level = str_replace_all(level, ">=", "\u2265"),
      level = str_replace_all(level, "<=", "\u2264"),
      level = fct_inorder(level)
    )

  if (strata == "all") {
    p <- r %>% ggplot(
      aes(x = !!sym(yearvar), y = rate, group = 1)
    ) +
      geom_line(linewidth = 1, colour = global_cols[1]) +
      geom_point(size = 2, colour = global_cols[1]) +
      scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
      theme_classic() +
      theme(
        panel.grid.major = element_line(
          color = "lightgrey",
          linewidth = 0.5,
          linetype = 2
        ),
        text = element_text(size = 15, face = "bold"),
        axis.text = element_text(color = "black")
      ) +
      labs(x = "Year", y = paste0(eventname, " / 100 person-years"))
  }

  if (strata != "all") {
    p <- r %>% ggplot(
      aes(x = !!sym(yearvar), y = rate, group = level)
    ) +
      geom_line(linewidth = 1, aes(color = level), show.legend = T) +
      geom_point(aes(col = level), size = 2, show.legend = T) +
      scale_color_manual(values = c(global_cols[1:2])) +
      scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
      theme_classic() +
      theme(
        panel.grid.major = element_line(
          color = "lightgrey",
          linewidth = 0.5,
          linetype = 2
        ),
        text = element_text(size = 15, face = "bold"),
        axis.text = element_text(color = "black"),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 20, face = "bold")
      ) +
      labs(x = "Year", y = paste0(eventname, " / 100 person-years"))
  }

  if (!is.null(ybreaks)) {
    p <- p + scale_y_continuous(
      limits = c(min(ybreaks), max(ybreaks)), breaks = ybreaks # , expand = c(0, 0)
    )
  }
  if (output) {
    create_pptx(p)
  }
  p
}
```

```{r}
#| label: fig-death
#| cache: true
#| cache.comments: false
#| dependson: trendfunc
#| fig-cap: "Temporal trends death"
#| fig-subcap: !expr c("All", "Age", "Sex")
#| layout-ncol: 2
#| layout-nrow: 2

i <- 1
ybreaks <- seq(0, 100, 20)

trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "all", ybreaks = ybreaks)
trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "shf_age_cat", addstrataname = "Age (years) ", ybreaks = ybreaks)
trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "shf_sex", ybreaks = ybreaks)
```

```{r}
#| label: fig-cvdeath
#| cache: true
#| cache.comments: false
#| dependson: trendfunc
#| fig-cap: "Temporal trends CV death"
#| fig-subcap: !expr c("All", "Age", "Sex")
#| layout-ncol: 2
#| layout-nrow: 2

i <- 2
ybreaks <- seq(0, 100, 20)

trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "all", ybreaks = ybreaks)
trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "shf_age_cat", addstrataname = "Age (years) ", ybreaks = ybreaks)
trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "shf_sex", ybreaks = ybreaks)
```


```{r}
#| label: fig-noncvdeath
#| cache: true
#| cache.comments: false
#| dependson: trendfunc
#| fig-cap: "Temporal trends Non-CV death"
#| fig-subcap: !expr c("All", "Age", "Sex")
#| layout-ncol: 2
#| layout-nrow: 2

i <- 3
ybreaks <- seq(0, 40, 10)

trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "all", ybreaks = ybreaks)
trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "shf_age_cat", addstrataname = "Age (years) ", ybreaks = ybreaks)
trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "shf_sex", ybreaks = ybreaks)
```


```{r}
#| label: fig-lvad
#| cache: true
#| cache.comments: false
#| dependson: trendfunc
#| fig-cap: "Temporal trends LVAD"
#| fig-subcap: !expr c("All", "Patients eligible for advanced HF therapy")
#| layout-ncol: 2
#| layout-nrow: 2

i <- 4
ybreaks <- seq(0, 20, 5)

trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "all", ybreaks = ybreaks, yearstart = 2015)

trendfunc(
  data = rsdata %>% filter(advhftreat == "Yes"), event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "all", ybreaks = ybreaks,
  yearstart = 2015
)
```


```{r}
#| label: fig-htx
#| cache: true
#| cache.comments: false
#| dependson: trendfunc
#| fig-cap: "Temporal trends Htx"
#| fig-subcap: !expr c("All", "Patients eligible for advanced HF therapy")
#| layout-ncol: 2
#| layout-nrow: 2

i <- 5
ybreaks <- seq(0, 20, 5)

trendfunc(event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "all", ybreaks = ybreaks)
trendfunc(data = rsdata %>% filter(advhftreat == "Yes"), event = outvars$var[i], time = outvars$time[i], eventname = outvars$shortname[i], strata = "all", ybreaks = ybreaks)
```
