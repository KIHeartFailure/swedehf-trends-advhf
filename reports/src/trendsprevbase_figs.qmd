```{r}
#| label: trendbasefunc
#| cache: true
#| cache.comments: false

trendbasefunc <- function(data, strata = NULL, addstrataname = NULL, ybreaks = seq(0, 100, 20), addpos = "first") {
  nlevel <- nlevels(data %>% pull(!!sym(strata)))
  prop <- data %>%
    filter(!is.na(!!sym(strata))) %>%
    group_by(indexyear_fac) %>%
    count(!!sym(strata)) %>%
    mutate(
      tot = sum(n),
      p = n / tot * 100
    ) %>%
    ungroup() %>%
    rename(level = !!sym(strata)) %>%
    mutate(
      level = case_when(
        addpos == "first" ~ paste(addstrataname, level),
        addpos == "last" ~ paste(level, addstrataname),
        TRUE ~ level
      ),
      level = str_remove_all(level, "Yes "),
      level = str_replace_all(level, ">=", "\u2265"),
      level = fct_inorder(level)
    )

  p <- prop %>% ggplot(
    aes(x = indexyear_fac, y = p, group = level)
  ) +
    geom_line(linewidth = 1, aes(color = level), show.legend = T) +
    geom_point(aes(col = level), size = 2, show.legend = T) +
    scale_color_manual(values = c(global_cols[1:nlevel])) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
    theme_classic() +
    theme(
      panel.grid.major = element_line(
        color = "lightgrey",
        linewidth = 0.5,
        linetype = 2
      ),
      text = element_text(size = 15, face = "bold"),
      axis.text = element_text(color = "black"),
      legend.position = "bottom",
      legend.title = element_blank(),
      legend.text = element_text(size = 20, face = "bold")
    ) +
    labs(x = "Year", y = "%") +
    scale_y_continuous(
      limits = c(min(ybreaks), max(ybreaks)), breaks = ybreaks # , expand = c(0, 0)
    )

  if (output) {
    create_pptx(p)
  }
  p
}
```

```{r}
#| label: fig-baseadvhf
#| cache: true
#| cache.comments: false
#| dependson: trendbasefunc
#| fig-cap: "Temporal trends in baseline characteristics for patients with advanced HF"
#| fig-subcap: !expr c("Age", "Sex", "CCI", "Beta-blocker", "RASi/ARNi", "MRA")
#| layout-ncol: 2
#| layout-nrow: 3

trendbasefunc(data = rsdata %>% filter(advhf == "Yes"), strata = "shf_age_cat", addstrataname = "Age (years)")
trendbasefunc(data = rsdata %>% filter(advhf == "Yes"), strata = "shf_sex")
trendbasefunc(data = rsdata %>% filter(advhf == "Yes"), strata = "sos_com_charlsonci_cat", addstrataname = "CCI")
trendbasefunc(data = rsdata %>% filter(advhf == "Yes"), strata = "shf_bbl", addstrataname = "Beta-blocker", addpos = "last")
trendbasefunc(data = rsdata %>% filter(advhf == "Yes"), strata = "shf_rasiarni", addstrataname = "RASi/ARNi", addpos = "last")
trendbasefunc(data = rsdata %>% filter(advhf == "Yes"), strata = "shf_mra", addstrataname = "MRA", addpos = "last")
```

```{r}
#| label: fig-baseadvhftreat
#| cache: true
#| cache.comments: false
#| dependson: trendprevfunc
#| fig-cap: "Temporal trends in baseline characteristics for patients with advanced HF eligible for AdvHF therapies"
#| fig-subcap: !expr c("Age", "Sex", "CCI", "Beta-blocker", "RASi/ARNi", "MRA")
#| layout-ncol: 2
#| layout-nrow: 3

trendbasefunc(data = rsdata %>% filter(advhftreat == "Yes"), strata = "shf_sex")
trendbasefunc(data = rsdata %>% filter(advhftreat == "Yes"), strata = "sos_com_charlsonci_cat", addstrataname = "CCI")
trendbasefunc(data = rsdata %>% filter(advhftreat == "Yes"), strata = "shf_bbl", addstrataname = "Beta-blocker", addpos = "last")
trendbasefunc(data = rsdata %>% filter(advhftreat == "Yes"), strata = "shf_rasiarni", addstrataname = "RASi/ARNi", addpos = "last")
trendbasefunc(data = rsdata %>% filter(advhftreat == "Yes"), strata = "shf_mra", addstrataname = "MRA", addpos = "last")
```
