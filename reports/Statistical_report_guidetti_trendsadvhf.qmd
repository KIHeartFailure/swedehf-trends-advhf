---
title: "Statistical report: Trends in prevalence and in mortality of patients with advanced heart failure with reduced EF in Sweden between 2003 and 2023"
subtitle: DRAFT
date: "`r Sys.Date()`"
cover: static/ki_logo_vert_rgb.png
editor: source
format:
  pdf:
    documentclass: scrartcl
    template-partials:
      - "static/before-body.tex"
      - "static/_titlepage.tex"
    include-in-header: 
      - "static/in-header.tex"
    toc: true
    toc-depth: 3
    toc-title: Contents
    lof: true
    lot: true
    cap-location: top
    number-sections: true
    colorlinks: false
    keep-tex: false
bibliography: static/references.bib
csl: static/bmj.csl
link-citations: true
link-bibliography: true
nocite: '@*'
knitr:
  opts_chunk: 
    dev: cairo_pdf
    collapse: true
    comment: "" 
    echo: FALSE
    include: TRUE
    warning: FALSE
    message: FALSE
    fig.pos: "H"
    fig.path: "../output/figs/"
    fig.height: 6
    fig.width: 10
    R.options:
      knitr.graphics.auto_pdf: true
---

```{r}
#| label: set-up-load-data
options(knitr.kable.NA = "")

# load packages, globals and project specific functions
source(here::here("setup/setup.R"))

# load data
load(here("data/clean-data/rsdata.RData"))

# load workbook to write tables to Excel
wb <- loadWorkbook(here("output/tabs/tables.xlsx"))
sheets <- names(wb)

# load pptx file with figs
figs <- officer::read_pptx(path = here::here("output/figs/figs.pptx"))

output <- TRUE
```           

\newpage

# Data

## Data sources

SHFDB version 4.2.2 is used that links the following Swedish registers through the 
Swedish personal identity number (PIN)[@pin]: 

{{< include src/datasources.qmd >}}

## Variable definitions

{{< include src/vars.qmd >}}

More information on data sources, definitions etc. are found https://kiheartfailure.github.io/shfdb4/.

## Inclusion/exclusion criteria

```{r}
#| label: tbl-flow
#| tbl-cap: Information for flowchart
#| tbl-pos: "H"

default_kable(flow) %>%
  row_spec(c(1, 11), bold = T)
```

First patient in: `r min(rsdata$shf_indexdtm)` and last patient in: `r max(rsdata$shf_indexdtm)` 
from approximately `r rsdata %>% distinct(shf_centre) %>% count() %>% pull(n)` enrolling centers. 

Baseline is date of visits or date of discharge for the visit/hospitalization recorded in SwedeHF. 

## Acknowledgments

Please include "We thank all staff members at care units reporting into the SwedeHF registry for their contribution." 
in the Acknowledgements of any resulting articles. 

## Ethics and Informed consent

The study was approved by the Swedish Ethical Review Authority, dnr 2021-04326. 
Individual consent was not required, but patients were informed of entry into SwedeHF and able to opt‚Äêout.

# Statistical analysis 

## General

All analyses were performed using `r sessionInfo()$R.version$version.string` [@r]. 
The level of significance is set to 5%, two-sided. No adjustment for multiple 
comparisons were made and therefore the results should be viewed with care.

## Baseline characteristics

Baseline characteristics are presented by advanced heart failure. 
Categorical variables are presented with n and percentage and tested for 
differences between groups with the chi-square test. 
Continuous variables are presented with median [first quartile-third quartile] and tested for 
differences between groups with the Kruskal-Wallis test. 

## Trends in 1 year outcomes

The following outcomes are considered: 

- `r outvars$name[1]`
- `r outvars$name[2]`
- `r outvars$name[3]`
- `r outvars$name[4]`
- `r outvars$name[5]`

Time trends will be calculated by dividing the number of first events per patient-years and presented as events per 100 person-years with Poisson rate 95% confidence intervals (CI). To identify possible mediators of potential time trends, standardized incidence rates will be obtained by Poisson regression, with stepwise adjustments as i) crude, ii) age and sex. The estimated annual percent change (eAPC) was also calculated using Poisson regression. 

\clearpage

# Results

```{r}
med <- rsdata %>%
  summarise(
    med = fn(median(shf_age), dig = 0),
    q1 = fn(quantile(shf_age, probs = 0.25), dig = 0),
    q3 = fn(quantile(shf_age, probs = 0.75), dig = 0)
  ) %>%
  mutate(out = paste0(med, " (", q1, "-", q3, ")")) %>%
  pull(out)

percfem <- rsdata %>%
  count(shf_sex) %>%
  mutate(perc = fn(n / sum(n) * 100, 0)) %>%
  filter(shf_sex == "Female") %>%
  pull(perc)
```

The median (q1-q3) age is `r med` and `r percfem`% females. 

## Baseline characteristics

Please check variables in table. Need any others? 

{{< include src/base_tab.qmd >}}

\clearpage

{{< include src/trendsprev_figs.qmd >}}

\clearpage

The below is WITHIN advHF (so the curves will at each year sum to 100%). Is this what you are after?

{{< include src/trendsprevbase_figs.qmd >}}

\clearpage

{{< include src/trendsout_figs.qmd >}}

\clearpage

{{< include src/trendsout.qmd >}}

TO BE ADDED: 

- LVAD outcome (now not for all years so need to know if years available or not)
- APC for prevalence 

\clearpage

# Reproducibility

## R code

The R code for all data handling and statistical analyses are found: 

https://github.com/KIHeartFailure/swedehf-trends-advhf. On publication
the repository will be made public so as to 
link to it from the resulting article for increased transparency and code sharing.
No data or output is stored in the repository. 

## R session information {#sessioninfo}

```{r sessinfo}
sessionInfo()
```

# References

::: {#refs}
:::
