---
title: "Statistical report: Trends in prevalence and in mortality of patients with advanced heart failure with reduced EF in Sweden between 2003 and 2022"
date: "`r Sys.Date()`"
cover: static/ki_logo_vert_rgb.png
editor: source
format:
  pdf:
    documentclass: scrartcl
    template-partials:
      - "static/before-body.tex"
      - "static/_titlepage.tex"
    include-in-header: 
      - "static/in-header.tex"
    toc: true
    toc-depth: 3
    toc-title: Contents
    lof: true
    lot: true
    cap-location: top
    number-sections: true
    colorlinks: false
    keep-tex: false
bibliography: static/references.bib
csl: static/bmj.csl
link-citations: true
link-bibliography: true
nocite: '@*'
knitr:
  opts_chunk: 
    dev: cairo_pdf
    collapse: true
    comment: "" 
    echo: FALSE
    include: TRUE
    warning: FALSE
    message: FALSE
    fig.pos: "H"
    fig.path: "../output/figs/"
    fig.height: 6
    fig.width: 10
    R.options:
      knitr.graphics.auto_pdf: true
---

```{r}
#| label: set-up-load-data
options(knitr.kable.NA = "")

# load packages, globals and project specific functions
source(here::here("setup/setup.R"))

# load data
load(here("data/clean-data/rsdata.RData"))

# load workbook to write tables to Excel
wb <- loadWorkbook(here("output/tabs/tables.xlsx"))
sheets <- names(wb)

# load pptx file with figs
figs <- officer::read_pptx(path = here::here("output/figs/figs.pptx"))

output <- TRUE
```           

\newpage

# Data

## Data sources

SHFDB version 4.2.2 is used that links the following Swedish registers through the 
Swedish personal identity number (PIN)[@pin]: 

{{< include src/datasources.qmd >}}

## Variable definitions

{{< include src/vars.qmd >}}

More information on data sources, definitions etc. are found https://kiheartfailure.github.io/shfdb4/.

### Target doses

```{r}
#| label: tbl-targetdoses
#| tbl-cap: Target doses
#| tbl-pos: "H"

koll_bbl <- rsdata %>%
  count(shf_bblsub) %>%
  mutate(med = "bbl") %>%
  rename(sub = shf_bblsub) %>%
  filter(!is.na(sub))
koll_acei <- rsdata %>%
  count(shf_aceisub) %>%
  mutate(med = "acei") %>%
  rename(sub = shf_aceisub) %>%
  filter(!is.na(sub))
koll_arb <- rsdata %>%
  count(shf_arbsub) %>%
  mutate(med = "arb") %>%
  rename(sub = shf_arbsub) %>%
  filter(!is.na(sub))
koll_arni <- rsdata %>%
  count(shf_arnidose) %>%
  mutate(med = "arni") %>%
  filter(!is.na(shf_arnidose))
koll_mra <- rsdata %>%
  count(shf_mrasub) %>%
  mutate(med = "mra") %>%
  rename(sub = shf_mrasub) %>%
  filter(!is.na(sub))

tg_all <- bind_rows(koll_bbl, koll_mra, koll_acei, koll_arb, koll_arni) %>% select(med, sub, shf_arnidose)

targetdoses <- inner_join(targetdoses %>% select(-ATC.code, -not.HF.recommended),
  tg_all,
  by = c("med", "sub", "shf_arnidose")
)

targetdoses <- bind_rows(
  targetdoses %>% filter(med != "arni") %>%
    mutate(targetdose = paste0(targetdose)),
  targetdoses %>% filter(med == "arni") %>%
    select(-targetdose) %>%
    rename(targetdose = targetdosearni) %>%
    group_by(med, targetdose) %>%
    summarise(shf_arnidose = paste0(shf_arnidose, collapse = ", "), .groups = "drop")
) %>%
  mutate(
    med = case_when(
      med == "bbl" ~ "Beta-blocker",
      med == "mra" ~ "MRA",
      med == "acei" ~ "ACEi",
      med == "arb" ~ "ARB",
      med == "arni" ~ "ARNi"
    )
  ) %>%
  select(-targetdosearni)


default_kable(targetdoses,
  col.names = c("Medication", "Substance", "ARNi dose", "Targetdose")
)
```

### Patients eligible for AdvHF therapies

Patients eligible for AdvHF therapies are defined as patients $\le$ 70 years with no previous dialysis within 5 years or cancer within 3 years.

## Inclusion/exclusion criteria

```{r}
#| label: tbl-flow
#| tbl-cap: Information for flowchart
#| tbl-pos: "H"

default_kable(flow) %>%
  row_spec(c(1, 11, 17), bold = T)
```

First patient in: `r min(rsdata$shf_indexdtm)` and last patient in: `r max(rsdata$shf_indexdtm)` 
from approximately `r rsdata %>% distinct(shf_centre) %>% count() %>% pull(n)` enrolling centers. 

Baseline is date of visits or date of discharge for the visit/hospitalization recorded in SwedeHF. 

## Acknowledgments

Include: "We thank all staff members at care units reporting into the SwedeHF registry for their contribution and the Swedish Heart Lung Foundation for financial support to the quality registers included in SWEDEHEART." in the Acknowledgements of any resulting articles. 


## Ethics and Informed consent

The study was approved by the Swedish Ethical Review Authority, dnr 2021-04326. 
Individual consent was not required, but patients were informed of entry into SwedeHF and able to opt‚Äêout.

# Statistical analysis 

## General

All analyses were performed using `r sessionInfo()$R.version$version.string` [@r]. 
The level of significance is set to 5%, two-sided. No adjustment for multiple 
comparisons were made and therefore the results should be viewed with care.

## Baseline characteristics

Categorical variables are presented with n and percentage and tested for 
differences between patients eligible and not eligible for advanced HF therapy with the chi-square test. 
Continuous variables are presented with median [first quartile-third quartile] and tested for 
differences between patients eligible and not eligible for advanced HF therapy with the Kruskal-Wallis test. 

## Trends in patients eligible for AdvHF therapies and selected baseline characteristics

Trends in the proportion of patients eligible for AdvHF therapies as well as patients in each age group, sex and GDMT are presented descriptively. 

## Trends in 1 year outcomes

The following outcomes are considered: 

- `r outvars$name[1]`
- `r outvars$name[2]`
- `r outvars$name[3]`
- `r outvars$name[4]`
- `r outvars$name[5]`

Time trends will be calculated by dividing the number of first events per patient-years and presented as events per 100 person-years with Poisson rate 95% confidence intervals (CI). 
To identify possible mediators of potential time trends, standardized incidence rates will be obtained by Poisson regression, partly crude and partly adjusting for age and sex. 
The estimated annual percent change (eAPC) was also calculated using Poisson regression. 

\clearpage

# Results

## Baseline characteristics

{{< include src/base_tab.qmd >}}

\clearpage

{{< include src/trendsprev.qmd >}}

\clearpage

{{< include src/trendsprevbase_figs.qmd >}}

\clearpage

{{< include src/trendsprevbase_tabs.qmd >}}

\clearpage

{{< include src/trendsout_figs.qmd >}}

\clearpage

{{< include src/trendsout_tabs.qmd >}}

\clearpage

# Reproducibility

## R code

The R code for all data handling and statistical analyses are found: 

https://github.com/KIHeartFailure/swedehf-trends-advhf. On publication
the repository will be made public so as to 
link to it from the resulting article for increased transparency and code sharing.
No data or output is stored in the repository. 

## R session information {#sessioninfo}

```{r sessinfo}
sessionInfo()
```

# References

::: {#refs}
:::
